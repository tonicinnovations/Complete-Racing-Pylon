{% set title = "Racing Pylon Control" %}
<!doctype html>
<html lang="en" data-bs-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    html { font-size: clamp(16px, 1.2vw + 12px, 18px); }
    body { -webkit-font-smoothing: antialiased; }
    .soft-card { border: 0; border-radius: 1rem; box-shadow: 0 6px 24px rgba(0,0,0,.08); }
    .btn-pill input[type="radio"], .btn-pill input[type="checkbox"] { display:none; }
    .btn-pill .btn { border-radius: 999px; min-width: 100px; text-align: center; font-size: 0.95rem; padding: 0.6rem 1rem; }
    .btn-outline-secondary.active-green { background-color: #198754; color: #fff; border-color: #198754; }
    .btn-outline-secondary.old-red { background-color: #dc3545; color: #fff; border-color: #dc3545; }
    .btn-disabled { opacity: 0.5; pointer-events: none; }
    .range-wrap { display: grid; grid-template-columns: 1fr auto; gap: .75rem; align-items: center; }
    main { padding-bottom: 5rem; }
    #toasts { position: fixed; right: 1rem; bottom: 1rem; z-index: 1080; }
    .status-dot { width: .75rem; height: .75rem; border-radius: 50%; display: inline-block; margin-right: .5rem; }
    label.form-label { font-weight: 600; }
    #logsSection { display: none; }
  </style>
  <script>
    (function() {
      try {
        var saved = localStorage.getItem('rp-theme');
        if (saved === 'light' || saved === 'dark') {
          document.documentElement.setAttribute('data-bs-theme', saved);
        } else if (!document.documentElement.getAttribute('data-bs-theme')) {
          var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          document.documentElement.setAttribute('data-bs-theme', prefersDark ? 'dark' : 'light');
        }
      } catch (e) {}
    })();
  </script>
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom sticky-top">
    <div class="container-xxl">
      <span class="navbar-brand fw-bold"><i class="bi bi-speedometer2 me-2"></i>{{ title }}</span>
      <div class="ms-auto d-flex gap-2">
        <span class="badge text-bg-secondary d-none d-sm-inline">Host: {{ hostname or 'Pi' }}</span>
        <button id="themeToggle" class="btn btn-outline-secondary btn-sm" type="button" aria-label="Toggle theme">
          <i class="bi bi-moon-stars"></i>
        </button>
      </div>
    </div>
  </nav>

  <main class="container-xxl py-4">
    <div class="row g-4">
      <div class="col-12 col-lg-4">
        <div class="card soft-card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <h2 class="h4 mb-0">Status</h2>
              <form method="post" action="/refresh" class="m-0">
                <button class="btn btn-outline-primary btn-sm" type="submit"><i class="bi bi-arrow-clockwise me-1"></i>Refresh</button>
              </form>
            </div>
            <hr />
            <div class="d-flex flex-column gap-3">
              <div>
                {% set running = pylon_running %}
                <span class="status-dot {{ 'bg-success' if running else 'bg-danger' }}"></span>
                <strong>Pylon Service:</strong>
                <span class="ms-2">{{ 'Running' if running else 'Stopped' }}</span>
              </div>
              <div>
                <strong>Series:</strong>
                <span class="ms-2">{{ config.series|upper }}</span>
              </div>
              <div>
                <strong>Display Mode:</strong>
                <span class="ms-2">{{ config.display_mode|title }}</span>
              </div>
              <div class="d-flex flex-wrap gap-3">
                <form method="post" action="/start" class="m-0">
                  <button class="btn btn-success btn-lg" type="submit"><i class="bi bi-play-fill me-1"></i>Start</button>
                </form>
                <form method="post" action="/stop" class="m-0">
                  <button class="btn btn-danger btn-lg" type="submit"><i class="bi bi-stop-fill me-1"></i>Stop</button>
                </form>
                <form method="post" action="/restart" class="m-0">
                  <button class="btn btn-warning btn-lg" type="submit"><i class="bi bi-arrow-repeat me-1"></i>Restart</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-8">
        <div class="card soft-card h-100">
          <div class="card-body">
            <h2 class="h4 mb-0">Configuration</h2>
            <hr />
            <form id="configForm" method="post" action="/save" class="d-flex flex-column gap-4">
              <section>
                <label class="form-label">Series</label>
                <div class="btn-group btn-pill flex-wrap" role="group" aria-label="Series selector">
                  {% for opt in series_options %}
                    {% set active = 'active' if opt.value==config.series else '' %}
                    <input type="radio" class="btn-check" name="series" id="series-{{ opt.value }}" value="{{ opt.value }}" autocomplete="off" {{ 'checked' if active else '' }} {% if opt.value in ['ARCA','INDY','F1'] %}disabled{% endif %}>
                    <label class="btn btn-outline-secondary {{ active }} d-flex flex-column align-items-center {% if opt.value in ['ARCA','INDY','F1'] %}btn-disabled{% endif %}" for="series-{{ opt.value }}">
                      <i class="bi {{ opt.icon }} me-1"></i>{{ opt.label }}
                      {% if opt.value in ['ARCA','INDY','F1'] %}<small class="text-muted">Coming Soon</small>{% endif %}
                    </label>
                  {% endfor %}
                  <input type="radio" class="btn-check" name="series" id="series-INDY" value="INDY" autocomplete="off" disabled>
                  <label class="btn btn-outline-secondary d-flex flex-column align-items-center btn-disabled" for="series-INDY">
                    <i class="bi bi-flag"></i>INDY
                    <small class="text-muted">Coming Soon</small>
                  </label>
                  <input type="radio" class="btn-check" name="series" id="series-F1" value="F1" autocomplete="off" disabled>
                  <label class="btn btn-outline-secondary d-flex flex-column align-items-center btn-disabled" for="series-F1">
                    <i class="bi bi-flag"></i>F1
                    <small class="text-muted">Coming Soon</small>
                  </label>
                </div>
              </section>

              <section>
                <label class="form-label">Display Mode</label>
                <div class="btn-group btn-pill flex-wrap" role="group" aria-label="Display mode">
                  {% for opt in display_modes %}
                    {% set active = 'active' if opt.value==config.display_mode else '' %}
                    <input type="radio" class="btn-check" name="display_mode" id="mode-{{ opt.value }}" value="{{ opt.value }}" {{ 'checked' if active else '' }}>
                    <label class="btn btn-outline-secondary {{ active }}" for="mode-{{ opt.value }}">
                      <i class="bi {{ opt.icon }} me-1"></i>{{ opt.label }}
                    </label>
                  {% endfor %}
                </div>
              </section>

              <section>
                <label class="form-label" for="favorite_driver">Favorite Driver #</label>
                <input type="number" min="0" max="999" step="1" inputmode="numeric"
                       id="favorite_driver" name="favorite_driver" class="form-control form-control-lg"
                       value="{{ config.favorite_driver or '' }}" placeholder="e.g., 9" />
                <div class="form-text">Leave blank to disable highlight.</div>
              </section>

              <section>
                <label class="form-label">TV Sync Adjustment (seconds)</label>
                <div class="range-wrap">
                  <input type="range" class="form-range" min="-30" max="30" step="0.1" id="delay_range" value="{{ config.tv_sync_delay|default(0, true) }}">
                  <input type="number" class="form-control form-control-lg" id="delay_number" name="tv_sync_delay" step="0.1"
                         value="{{ config.tv_sync_delay|default(0, true) }}">
                </div>
                <div class="form-text">Adjust negative if the pylon runs ahead of TV, adjust positive if the pylon lags TV.</div>
              </section>

              <section class="row g-3">
                <div class="col-12 col-md-6">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="show_deltas" name="show_deltas" {{ 'checked' if config.show_deltas else '' }}>
                    <label class="form-check-label" for="show_deltas">Show Delta Colors</label>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="auto_restart" name="auto_restart" {{ 'checked' if config.auto_restart else '' }}>
                    <label class="form-check-label" for="auto_restart">Auto Restart on Save</label>
                  </div>
                </div>
              </section>

              <div class="d-flex flex-wrap gap-3">
                <button class="btn btn-primary btn-lg" type="submit"><i class="bi bi-save2 me-1"></i>Save</button>
                <button class="btn btn-outline-secondary btn-lg" type="reset"><i class="bi bi-arrow-counterclockwise me-1"></i>Reset</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card soft-card">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
              <h2 class="h4 mb-0">Recent Logs</h2>
              <div>
                <button id="toggleLogs" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-journal-text me-1"></i>Show Logs</button>
                <form method="post" action="/logs/refresh" class="d-inline">
                  <button class="btn btn-outline-primary btn-sm" type="submit"><i class="bi bi-arrow-clockwise me-1"></i>Refresh Logs</button>
                </form>
              </div>
            </div>
            <div id="logsSection">
              <pre class="mb-0" style="white-space: pre-wrap; max-height: 40vh; overflow:auto;">{{ logs or 'No logs yet.' }}</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="border-top py-3 bg-body-tertiary">
    <div class="container-xxl d-flex justify-content-between align-items-center flex-wrap gap-2">
      <small class="text-muted">&copy; {{ year or 2025 }} RacingPylons</small>
      <small class="text-muted">Theme adapts to your system (light/dark)</small>
    </div>
  </footer>

  <div id="toasts" class="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        const html = document.documentElement;
        const current = html.getAttribute('data-bs-theme') || 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-bs-theme', next);
        try { localStorage.setItem('rp-theme', next); } catch (e) {}
        showToast(`Theme: ${next}`);
      });
    }

    const delayRange = document.getElementById('delay_range');
    const delayNumber = document.getElementById('delay_number');
    function syncDelay(fromRange) {
      if (!delayRange || !delayNumber) return;
      if (fromRange) delayNumber.value = delayRange.value;
      else delayRange.value = delayNumber.value;
    }
    if (delayRange && delayNumber) {
      delayRange.addEventListener('input', () => syncDelay(true));
      delayNumber.addEventListener('input', () => syncDelay(false));
    }

    const configForm = document.getElementById('configForm');
    if (configForm) {
      configForm.addEventListener('submit', () => {
        document.querySelectorAll('.btn-check + label').forEach(lbl => {
          lbl.classList.remove('active-green', 'old-red');
        });
        showToast('Saving configuration...');
      });
    }

    document.querySelectorAll('.btn-check').forEach(input => {
      input.addEventListener('change', () => {
        const group = input.name;
        document.querySelectorAll(`input[name="${group}"] + label`).forEach(lbl => {
          lbl.classList.remove('active-green', 'old-red');
        });
        document.querySelectorAll(`input[name="${group}"]:not(:checked) + label.active`).forEach(lbl => {
          lbl.classList.add('old-red');
        });
        if (input.checked) {
          const label = document.querySelector(`label[for="${input.id}"]`);
          label.classList.add('active-green');
        }
      });
    });

    const toggleLogsBtn = document.getElementById('toggleLogs');
    const logsSection = document.getElementById('logsSection');
    if (toggleLogsBtn && logsSection) {
      toggleLogsBtn.addEventListener('click', () => {
        if (logsSection.style.display === 'none' || logsSection.style.display === '') {
          logsSection.style.display = 'block';
          toggleLogsBtn.innerHTML = '<i class="bi bi-journal-text me-1"></i>Hide Logs';
        } else {
          logsSection.style.display = 'none';
          toggleLogsBtn.innerHTML = '<i class="bi bi-journal-text me-1"></i>Show Logs';
        }
      });
    }

    function showToast(message, delay=2000) {
      const container = document.getElementById('toasts');
      const el = document.createElement('div');
      el.className = 'toast align-items-center text-bg-primary border-0';
      el.setAttribute('role', 'status');
      el.setAttribute('aria-live', 'polite');
      el.setAttribute('aria-atomic', 'true');
      el.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>`;
      container.appendChild(el);
      const t = new bootstrap.Toast(el, { delay });
      t.show();
      el.addEventListener('hidden.bs.toast', () => el.remove());
    }
  </script>
</body>
</html>
